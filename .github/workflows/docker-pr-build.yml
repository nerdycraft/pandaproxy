name: Build PR Docker Image (on command)

# Triggered by maintainer comment "/build-pr" on a pull request
# This provides a security gate - code is reviewed before images are published

on:
  issue_comment:
    types: [created]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # First job: Check if this is a valid trigger
  check-trigger:
    name: Validate Trigger
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
      issues: write
    # Only run if:
    # 1. Comment is on a PR (not an issue)
    # 2. Comment body is exactly "/build-pr"
    if: |
      github.event.issue.pull_request &&
      github.event.comment.body == '/build-pr'
    outputs:
      pr_number: ${{ steps.pr.outputs.number }}
      pr_head_sha: ${{ steps.pr.outputs.head_sha }}
      pr_head_ref: ${{ steps.pr.outputs.head_ref }}
      authorized: ${{ steps.auth.outputs.authorized }}

    steps:
      - name: Get PR details
        id: pr
        uses: actions/github-script@v8
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('number', pr.data.number);
            core.setOutput('head_sha', pr.data.head.sha);
            core.setOutput('head_ref', pr.data.head.ref);
            console.log(`PR #${pr.data.number} - SHA: ${pr.data.head.sha}`);

      - name: Check commenter permissions
        id: auth
        uses: actions/github-script@v8
        with:
          script: |
            const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: context.actor
            });
            const level = permission.permission;
            // Allow: admin, maintain, write (but not: triage, read)
            const authorized = ['admin', 'maintain', 'write'].includes(level);
            console.log(`User ${context.actor} has permission: ${level} - Authorized: ${authorized}`);
            core.setOutput('authorized', authorized);
            if (!authorized) {
              core.setFailed(`User ${context.actor} does not have write access to trigger PR builds`);
            }

      - name: Add reaction to comment
        # This may fail due to GITHUB_TOKEN limitations on issue_comment events
        # The reaction is just visual feedback, not critical to the workflow
        continue-on-error: true
        if: steps.auth.outputs.authorized == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });

  # Second job: Build and push the Docker image
  build:
    name: Build & Push PR Image
    runs-on: ubuntu-latest
    needs: check-trigger
    if: needs.check-trigger.outputs.authorized == 'true'
    permissions:
      contents: read
      packages: write
      pull-requests: write

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.check-trigger.outputs.pr_head_sha }}
          fetch-depth: 0

      - name: Extract version from git
        id: version
        run: |
          # For PRs: convert git describe to PEP 440 format
          RAW=$(git describe --tags --always | sed 's/^v//')
          if [[ "$RAW" =~ ^([0-9]+\.[0-9]+\.[0-9]+)-([0-9]+)-g([a-f0-9]+)$ ]]; then
            VERSION="${BASH_REMATCH[1]}.dev${BASH_REMATCH[2]}+g${BASH_REMATCH[3]}"
          else
            VERSION="$RAW"
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Detected version: ${VERSION}"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:pr-${{ needs.check-trigger.outputs.pr_number }}
          labels: |
            org.opencontainers.image.title=PandaProxy
            org.opencontainers.image.description=PR build for testing
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ needs.check-trigger.outputs.pr_head_sha }}
          build-args: |
            VERSION=${{ steps.version.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Verify pushed image (amd64)
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:pr-${{ needs.check-trigger.outputs.pr_number }}"
          docker pull "${IMAGE}"
          EXPECTED="PandaProxy v${{ steps.version.outputs.version }}"
          ACTUAL=$(docker run --rm "${IMAGE}" --version)
          echo "Expected: ${EXPECTED}"
          echo "Actual:   ${ACTUAL}"
          if [[ "${ACTUAL}" != "${EXPECTED}" ]]; then
            echo "::error::Version mismatch in pushed image!"
            exit 1
          fi
          echo "‚úÖ Version verified in pushed image"

      - name: Comment on PR with image info
        uses: actions/github-script@v8
        with:
          script: |
            const image = `${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:pr-${{ needs.check-trigger.outputs.pr_number }}`;
            const sha = '${{ needs.check-trigger.outputs.pr_head_sha }}'.substring(0, 7);
            const body = `## üê≥ PR Docker Image Built

            **Image:** \`${image}\`
            **Commit:** \`${sha}\`
            **Platforms:** \`linux/amd64\`, \`linux/arm64\`

            \`\`\`bash
            docker pull ${image}
            \`\`\`

            > ‚ö†Ô∏è This is a PR build for testing purposes. Do not use in production.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.check-trigger.outputs.pr_number }},
              body: body
            });
